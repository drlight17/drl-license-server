<!DOCTYPE html>
<html lang="<?= htmlspecialchars($currentLocale); ?>"
      data-locale="<?= htmlspecialchars($currentLocale); ?>"
      data-is-admin="<?= $isAdmin ? 'true' : 'false'; ?>"
      data-admin-key="<?= htmlspecialchars($adminKey, ENT_QUOTES, 'UTF-8'); ?>">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><?= htmlspecialchars($lang['login_title'] ?? 'Login'); ?></title>
    <link rel="icon" type="image/x-icon" href="/css/favicon.ico">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fomantic-ui@2.9.3/dist/semantic.min.css  ">
    <link rel="stylesheet" href="/css/style.css">
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js  "></script>
    <script src="https://cdn.jsdelivr.net/npm/fomantic-ui@2.9.3/dist/semantic.min.js  "></script>
    <script id="lang-data" type="application/json">
        <?= json_encode($lang); ?>
    </script>
    <!-- Connecting external JS file -->
    <script src="/js/main.js" defer></script>
</head>
<body>
    <!-- Language Switcher -->
    <div id="language-switcher">
        <select id="language-select" class="ui dropdown small compact">
            <option value="en" <?= $currentLocale === 'en' ? 'selected' : ''; ?>>EN</option>
            <option value="ru" <?= $currentLocale === 'ru' ? 'selected' : ''; ?>>RU</option>
        </select>
    </div>
    <div id="theme-toggle" title="<?= htmlspecialchars($lang['theme_toggle_title'] ?? 'Toggle theme'); ?>">
        <i class="moon icon"></i> <!-- Icon will change in JS -->
    </div>
    <div class="ui container wide">
        <div class="ui center aligned header">
            <div class="logo">
                <i class="key icon"></i>
                <?= htmlspecialchars($lang['login_title'] ?? 'Login'); ?>
            </div>
        </div>

        <?php if (!$isAdmin): ?>
            <!-- Login Form -->
            <div class="ui middle aligned center aligned grid">
                <div class="login column">
                    <div class="ui segment">
                        <div class="ui header">
                            <i class="lock icon"></i>
                            <div class="content">
                                <?= htmlspecialchars($lang['login_header'] ?? 'Admin Login'); ?>
                                <div class="sub header"><?= htmlspecialchars($lang['login_subheader'] ?? 'Enter your admin key to access the panel.'); ?></div>
                            </div>
                        </div>
                        <?php if (isset($loginError)): ?>
                            <div class="ui negative message">
                                <i class="close icon"></i>
                                <div class="header"><?= htmlspecialchars($lang['login_error_title'] ?? 'Login Error'); ?></div>
                                <p><?= htmlspecialchars($loginError); ?></p>
                            </div>
                        <?php endif; ?>
                        <form class="ui large form" method="POST">
                            <div class="ui stacked segment">
                                <div class="field">
                                    <div class="ui left icon input">
                                        <i class="key icon"></i>
                                        <input type="password" name="admin_key" placeholder="<?= htmlspecialchars($lang['login_placeholder'] ?? 'Admin Key'); ?>" required>
                                    </div>
                                </div>
                                <button class="ui fluid large primary submit button" type="submit">
                                    <i class="sign in icon"></i>
                                    <?= htmlspecialchars($lang['login_button'] ?? 'Login'); ?>
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        <?php else: ?>
            <!-- Main Interface -->
            <div class="ui stackable grid">
                <!-- Sidebar -->
                <div class="three wide column">
                    <div class="ui vertical fluid tabular menu">
                        <a class="item active" data-tab="dashboard">
                            <i class="dashboard icon"></i>
                            <?= htmlspecialchars($lang['nav_dashboard'] ?? 'Dashboard'); ?>
                        </a>
                        <a class="item" data-tab="licenses" onclick="applyFilters(1);">
                            <i class="list icon"></i>
                            <?= htmlspecialchars($lang['nav_licenses'] ?? 'Licenses'); ?>
                        </a>
                        <a class="item" data-tab="logs">
                            <i class="file alternate icon"></i>
                            <?= htmlspecialchars($lang['nav_logs'] ?? 'Logs'); ?>
                        </a>
                        <a class="item" href="/api/swagger?lang=<?= $currentLocale; ?>" target="_blank">
                            <i class="code icon"></i>
                            <?= htmlspecialchars($lang['nav_api_docs'] ?? 'API Docs'); ?>
                        </a>
                        <a class="item" href="?logout=1&lang=<?= $currentLocale; ?>">
                            <i class="sign out icon"></i>
                            <?= htmlspecialchars($lang['nav_logout'] ?? 'Logout'); ?>
                        </a>
                    </div>
                </div>
                <!-- Content Area -->
                <div class="thirteen wide column">
                    <!-- Dashboard Tab -->
                    <div class="ui tab active" data-tab="dashboard">
                        <div class="ui header">
                            <i class="dashboard icon"></i>
                            <div class="content">
                                <?= htmlspecialchars($lang['dashboard_title'] ?? 'Dashboard'); ?>
                                <div class="sub header"><?= htmlspecialchars($lang['dashboard_subheader'] ?? 'Overview and quick actions.'); ?></div>
                            </div>
                        </div>
                        <div class="ui four column stackable grid">
                            <div class="column">
                                <div class="ui card">
                                    <div class="content">
                                        <div class="header">
                                            <i class="key icon"></i>
                                            <?= htmlspecialchars($lang['dashboard_card_licenses'] ?? 'Manage Licenses'); ?>
                                        </div>
                                        <div class="description">
                                            <p><?= htmlspecialchars($lang['dashboard_card_licenses_desc'] ?? 'View, create, and manage software licenses.'); ?></p>
                                        </div>
                                    </div>
                                    <div class="extra content">
                                        <button class="ui small primary button" onclick="$('.menu .item').tab('change tab', 'licenses'); applyFilters(1);">
                                            <?= htmlspecialchars($lang['dashboard_card_licenses_btn'] ?? 'Go to Licenses'); ?>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="column">
                                <div class="ui card">
                                    <div class="content">
                                        <div class="header">
                                            <i class="file icon"></i>
                                            <?= htmlspecialchars($lang['dashboard_card_logs'] ?? 'View Logs'); ?>
                                        </div>
                                        <div class="description">
                                            <p><?= htmlspecialchars($lang['dashboard_card_logs_desc'] ?? 'Inspect system logs and API activity.'); ?></p>
                                        </div>
                                    </div>
                                    <div class="extra content">
                                        <button class="ui small button" onclick="$('.menu .item').tab('change tab', 'logs')">
                                            <?= htmlspecialchars($lang['dashboard_card_logs_btn'] ?? 'View Logs'); ?>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="column">
                                <div class="ui card">
                                    <div class="content">
                                        <div class="header">
                                            <i class="envelope icon"></i> <!-- Icon for email -->
                                            <?= htmlspecialchars($lang['dashboard_card_email'] ?? 'Test Email'); ?>
                                        </div>
                                        <div class="description">
                                            <p><?= htmlspecialchars($lang['dashboard_card_email_desc'] ?? 'Send a test email to verify configuration.'); ?></p>
                                            <!-- Test email send button -->
                                            <button class="ui small button" id="sendTestEmailBtn">
                                                <i class="paper plane icon"></i> <?= htmlspecialchars($lang['dashboard_card_email_btn'] ?? 'Send Test Email'); ?>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="extra content">
                                        <!-- Area for displaying send log -->
                                        <div class="ui segment" style="max-height: 200px; overflow-y: auto; display: none;" id="emailTestLog">
                                            <div class="ui header"><?= htmlspecialchars($lang['email_test_log'] ?? 'Email Test Log'); ?></div>
                                            <pre id="emailTestLogContent" style="white-space: pre-wrap; font-size: 0.8em;"></pre>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="column">
                                <div class="ui card">
                                    <div class="content">
                                        <div class="header">
                                            <i class="help icon"></i>
                                            <?= htmlspecialchars($lang['dashboard_card_help'] ?? 'API Documentation'); ?>
                                        </div>
                                        <div class="description">
                                            <p><?= htmlspecialchars($lang['dashboard_card_help_desc'] ?? 'Access detailed API documentation and examples.'); ?></p>
                                        </div>
                                    </div>
                                    <div class="extra content">
                                        <button class="ui small button" onclick="window.open('/api/swagger?lang=<?= $currentLocale; ?>', '_blank')">
                                            <i class="code icon"></i> <?= htmlspecialchars($lang['dashboard_card_help_btn'] ?? 'Open Docs'); ?>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Manage Licenses Tab -->
                    <div class="ui tab" data-tab="licenses">
                        <div class="ui header">
                            <i class="list icon"></i>
                            <div class="content">
                                <?= htmlspecialchars($lang['licenses_title'] ?? 'Manage Licenses'); ?>
                                <div class="sub header"><?= htmlspecialchars($lang['licenses_subheader'] ?? 'Create, view, and manage software licenses.'); ?></div>
                            </div>
                        </div>
                        <div class="ui segment">
                            <!-- Search Controls -->
                            <div class="search-controls">
                                <div class="ui form">
                                    <div class="fields">
                                        <div class="eight wide field">
                                            <label><?= htmlspecialchars($lang['licenses_search_placeholder'] ?? 'Search Licenses...'); ?></label>
                                            <input type="text" id="licenseSearch" placeholder="<?= htmlspecialchars($lang['licenses_search_placeholder'] ?? 'Search Licenses...'); ?>">
                                        </div>
                                        <div class="four wide field">
                                            <label><?= htmlspecialchars($lang['licenses_filter_status'] ?? 'Filter by Status'); ?></label>
                                            <select class="ui dropdown" id="statusFilter">
                                                <option value=""><?= htmlspecialchars($lang['licenses_filter_status_all'] ?? 'All Statuses'); ?></option>
                                                <option value="all"><?= htmlspecialchars($lang['licenses_filter_status_all'] ?? 'All Statuses'); ?></option>
                                                <option value="active"><?= htmlspecialchars($lang['licenses_filter_status_active'] ?? 'Active'); ?></option>
                                                <option value="inactive"><?= htmlspecialchars($lang['licenses_filter_status_inactive'] ?? 'Inactive'); ?></option>
                                                <option value="expired"><?= htmlspecialchars($lang['licenses_filter_status_expired'] ?? 'Expired'); ?></option>
                                            </select>
                                        </div>
                                        <div class="four wide field">
                                            <label><?= htmlspecialchars($lang['licenses_per_page'] ?? 'Entries per page'); ?></label>
                                            <select class="ui dropdown" id="licensesPerPage">
                                                <option value="5" selected>5</option>
                                                <option value="10">10</option>
                                                <option value="20">20</option>
                                                <option value="50">50</option>
                                                <option value="100">100</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="fields">
                                        <div class="four wide field">
                                            <label>&nbsp;</label>
                                            <button class="ui primary button" id="applyFilters">
                                                <i class="filter icon"></i>
                                                <?= htmlspecialchars($lang['licenses_apply_filters'] ?? 'Apply Filters'); ?>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- License Table -->
                            <div class="ui segment">
                                <div class="scrollable-table-container">
                                    <div class="license-table-wrapper"> <!-- Added external container for horizontal scrolling -->
                                        <div class="license-table-container"> <!-- Existing container -->
                                            <table class="ui celled table license-table">
                                                <thead>
                                                    <tr>
                                                        <th class="sortable" data-sort="key"><?= htmlspecialchars($lang['licenses_table_key'] ?? 'License Key'); ?> <i class="sort icon"></i></th>
                                                        <th class="sortable" data-sort="user"><?= htmlspecialchars($lang['licenses_table_user'] ?? 'User'); ?> <i class="sort icon"></i></th>
                                                        <th class="sortable" data-sort="ip"><?= htmlspecialchars($lang['licenses_table_ip'] ?? 'IP Address'); ?> <i class="sort icon"></i></th>
                                                        <th class="sortable" data-sort="product"><?= htmlspecialchars($lang['licenses_table_product'] ?? 'Product'); ?> <i class="sort icon"></i></th>
                                                        <th class="sortable" data-sort="status"><?= htmlspecialchars($lang['licenses_table_status'] ?? 'Status'); ?> <i class="sort icon"></i></th>
                                                        <th class="sortable" data-sort="created"><?= htmlspecialchars($lang['licenses_table_created'] ?? 'Created'); ?> <i class="sort icon"></i></th>
                                                        <th class="sortable" data-sort="expires"><?= htmlspecialchars($lang['licenses_table_expires'] ?? 'Expires'); ?> <i class="sort icon"></i></th>
                                                        <th><?= htmlspecialchars($lang['licenses_table_actions'] ?? 'Actions'); ?></th>
                                                    </tr>
                                                </thead>
                                                <tbody id="licenseTableBody">
                                                    <tr>
                                                        <td colspan="8" class="center aligned">
                                                            <div class="ui active centered inline loader"><?= htmlspecialchars($lang['licenses_loading'] ?? 'Loading...'); ?></div>
                                                        </td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div> <!-- Closing .license-table-container -->
                                    </div> <!-- Closing .license-table-wrapper -->
                                    <div class="scroll-overlay left-overlay"></div>
                                    <div class="scroll-overlay right-overlay"></div>
                                </div>
                                <!-- Create License Button (+) -->
                                <div id="showCreateForm_div" class="ui center aligned segment">
                                    <button class="ui large circular icon button" id="showCreateForm" title="<?= htmlspecialchars($lang['licenses_create_button_title'] ?? 'Create New License'); ?>">
                                        <i class="plus icon"></i>
                                    </button>
                                </div>
                                <!-- Pagination for Licenses - Wrapped in container for stickiness -->
                                <div class="ui form licensesPaginationContainer">
                                    <div class="ui pagination menu" id="licensesPagination">
                                        <!-- Pagination buttons will be generated here -->
                                    </div>
                                </div>
                                <!-- End of sticky pagination -->
                                <!-- Create License Form (Hidden by default) -->
                                <div class="ui segment" id="createLicenseForm" >
                                    <h4 class="ui header">
                                        <i class="plus circle icon"></i>
                                        <div class="content">
                                            <?= htmlspecialchars($lang['licenses_create_title'] ?? 'Create New License'); ?>
                                            <div class="sub header"><?= htmlspecialchars($lang['licenses_create_subheader'] ?? 'Fill in the details to generate a new license.'); ?></div>
                                        </div>
                                    </h4>
                                    <form class="ui form" id="licenseCreationForm">
                                        <div class="fields">
                                            <div class="four wide field">
                                                <label><?= htmlspecialchars($lang['licenses_create_user_label'] ?? 'User Email'); ?></label>
                                                <input type="email" name="user" placeholder="user@example.com" required>
                                            </div>
                                            <div class="four wide field">
                                                <label><?= htmlspecialchars($lang['licenses_create_product_label'] ?? 'Product Name'); ?></label>
                                                <input type="text" name="product" placeholder="MyApp Pro" value="Default Product">
                                            </div>
                                            <div class="three wide field">
                                                <label><?= htmlspecialchars($lang['licenses_create_days_label'] ?? 'Days Valid'); ?></label>
                                                <input type="number" name="days" placeholder="365" value="0" min="0">
                                            </div>
                                            <div class="five wide field">
                                                <label><?= htmlspecialchars($lang['licenses_create_custom_key_label'] ?? 'Custom Key (Optional)'); ?></label>
                                                <input type="text" name="custom_key" placeholder="XXXX-XXXX-XXXX-XXXX">
                                            </div>
                                        </div>
                                        <input type="hidden" name="admin_key" value="<?= htmlspecialchars($adminKey); ?>">
                                        <input type="hidden" name="action" value="create">
                                        <button class="ui primary button" type="submit">
                                            <i class="plus icon"></i>
                                            <?= htmlspecialchars($lang['licenses_create_button'] ?? 'Create License'); ?>
                                        </button>
                                        <button class="ui button" type="button" id="cancelCreateLicense">
                                            <i class="cancel icon"></i>
                                            <?= htmlspecialchars($lang['licenses_cancel_button'] ?? 'Cancel'); ?>
                                        </button>
                                    </form>
                                    <div id="createResult"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- View Logs Tab -->
                    <div class="ui tab" data-tab="logs">
                        <div class="ui header">
                            <i class="file alternate icon"></i>
                            <div class="content">
                                <?= htmlspecialchars($lang['logs_title'] ?? 'System Logs'); ?>
                                <div class="sub header"><?= htmlspecialchars($lang['logs_subheader'] ?? 'View detailed logs of system activity.'); ?></div>
                            </div>
                        </div>
                        <div class="ui segment">
                            <div class="ui form">
                                <div class="fields">
                                    <!-- Existing "Entries per page" filter -->
                                    <div class="four wide field">
                                        <label><?= htmlspecialchars($lang['logs_entries_per_page'] ?? 'Entries per page'); ?></label>
                                        <select class="ui dropdown" id="logsPerPage">
                                            <option value="5">5</option>
                                            <option value="10" selected>10</option>
                                            <option value="25">25</option>
                                            <option value="50">50</option>
                                            <option value="100">100</option>
                                        </select>
                                    </div>
                                    <!-- New "Operation Type" filter -->
                                    <div class="four wide field">
                                        <label><?= htmlspecialchars($lang['logs_operation_type'] ?? 'Operation Type'); ?></label>
                                        <select class="ui dropdown" id="logOperationFilter">
                                            <option value=""><?= htmlspecialchars($lang['logs_operation_all'] ?? 'All Operations'); ?></option>
                                            <option value="all"><?= htmlspecialchars($lang['logs_operation_all'] ?? 'All Operations'); ?></option>
                                            <option value="validate"><?= htmlspecialchars($lang['logs_operation_validate'] ?? 'Validate'); ?></option>
                                            <option value="activate"><?= htmlspecialchars($lang['logs_operation_activate'] ?? 'Activate'); ?></option>
                                            <option value="create"><?= htmlspecialchars($lang['logs_operation_create'] ?? 'Create'); ?></option>
                                            <option value="delete"><?= htmlspecialchars($lang['logs_operation_delete'] ?? 'Delete'); ?></option>
                                            <option value="list"><?= htmlspecialchars($lang['logs_operation_list'] ?? 'List'); ?></option>
                                            <option value="logs_access"><?= htmlspecialchars($lang['logs_operation_logs_access'] ?? 'Logs Access'); ?></option>
                                            <option value="error"><?= htmlspecialchars($lang['logs_operation_error'] ?? 'Error'); ?></option>
                                        </select>
                                    </div>
                                    <!-- Refresh button with changed ID for clarity -->
                                    <div class="four wide field">
                                        <label>&nbsp;</label>
                                        <button class="ui primary button" id="refreshLogsBtn">
                                            <i class="refresh icon"></i>
                                            <?= htmlspecialchars($lang['logs_refresh_button'] ?? 'Refresh'); ?>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div id="logsResult">
                                <div class="ui active centered inline loader"><?= htmlspecialchars($lang['logs_loading'] ?? 'Loading logs...'); ?></div>
                            </div>
                            <!-- Pagination for Logs -->
                            <div class="ui form logsPaginationContainer">
                                <div class="ui pagination menu" id="logsPagination">
                                    <!-- Pagination buttons will be generated here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        <?php endif; ?>
    </div>
    <div class="footer">
        <div class="ui container">
            <p><?= htmlspecialchars($lang['footer_copyright'] ?? '&copy; Company'); ?> <?= date('Y'); ?></p>
        </div>
        <a href="mailto:root@drlight.fun"><img class="mailto" src="/css/developed_by_drlight.png"></a>
    </div>
    <script>
       // Initialize the application after DOM loading
       $(document).ready(function() {
           // Call the initialization function from the external JS file
           initializeApp();
       });
    </script>
</body>
</html>